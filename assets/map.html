<!DOCTYPE html>
<html>
<head>
    <title>OpenStreetMap con Leaflet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        #mapid {
            height: 100vh;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .user-marker-icon {
            background-color: #00ff44;
            width: 20px;
            height: 20px;
            display: block;
            left: -10px;
            top: -10px;
            position: relative;
            border-radius: 50%;
            border: 3px solid rgb(0, 115, 40);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }
        .search-marker-icon {
            background-color: #ff0000; /* Un color diferente para el marcador de b煤squeda */
            width: 20px;
            height: 20px;
            display: block;
            left: -10px;
            top: -10px;
            position: relative;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }
        .bus-marker-icon {
    width: 20px;
    height: 20px;
    display: flex; 
    justify-content: center;
    align-items: center;
}
    </style>
</head>
<body>
    <div id="mapid"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Inicializaci贸n del Mapa
        let map;
        let busMarkers = {}
        let userMarker = null;
        let allBusStopsData = null;
        let busStopsLayer = null;
        let searchMarker = null; // Nuevo marcador para la ubicaci贸n buscada
        let isMapInitialized = false;
        

        const INITIAL_CENTER = { latitude: 10.5000, longitude: -66.9167 }
        const initialLat = INITIAL_CENTER.latitude;
        const initialLon = INITIAL_CENTER.longitude;
        function initializeMap() {
    if (isMapInitialized) return;
    map = L.map('mapid', {
        zoomControl: false
    }).setView([initialLat, initialLon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: ''
    }).addTo(map);

    // Utilizamos map.whenReady para garantizar que Leaflet est茅 100% listo.
    map.whenReady(function() {
        isMapInitialized = true;
        // Solo enviamos el mensaje UNA VEZ aqu铆
        if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage('MAP_LOADED');
        }
    });
}
initializeMap();

        // 1). Funci贸n JS que ser谩 llamada desde React Natve para actualizar la ubicaci贸n del USUARIO
        window.updateUserMarker = function(lat, lon) {
            const latlng = [lat, lon];
            const userIcon = L.divIcon({
                className: 'user-marker-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
            if (userMarker) {
                userMarker.setLatLng(latlng);
            } else {
                userMarker = L.marker(latlng, { icon: userIcon }).addTo(map)
                    .bindPopup("Est谩s aqu铆").openPopup();
            }
                map.setView(latlng, 15);
        };
        // 2). Nueva funci贸n JS para marcar una ubicaci贸n buscada
        window.updateSearchMarker = function(lat, lon, address) {
          const latlng = [lat, lon];
            const searchIcon = L.divIcon({
                className: 'search-marker-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
            if (searchMarker) {
                searchMarker.setLatLng(latlng);
                searchMarker.setPopupContent(address);
            } else {
                searchMarker = L.marker(latlng, { icon: searchIcon }).addTo(map)
                    .bindPopup(address);
            }
            searchMarker.openPopup();
            // Centrar el mapa en la ubicaci贸n buscada
            map.flyTo(latlng, 15, {
                duration: 1.5
            });
            window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'SEARCH_UPDATED', lat, lon, address }));
        };

        // 3. Funci贸n de Renderizado de Paradas (Nueva)
        window.renderBusStops = function(overpassData) {
        // Limpiar paradas anteriores
        if (busStopsLayer) {
            map.removeLayer(busStopsLayer);
        }
        
        busStopsLayer = L.layerGroup().addTo(map);

        if (overpassData && overpassData.elements) {
            
            const stopIcon = L.divIcon({
                className: 'bus-stop-icon',
                html: '<div style="background-color: #0661BC; border-radius: 50%; width: 12px; height: 12px; border: 2px solid white;"></div>', 
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            overpassData.elements.forEach(element => {
                if (element.type === 'node') {
                    const lat = element.lat;
                    const lon = element.lon;
                    const name = (element.tags && element.tags.name) ? element.tags.name : 'Parada de bus';
                    
                    L.marker([lat, lon], { icon: stopIcon })
                        .bindPopup(`<b>Parada:</b> ${name}`)
                        .addTo(busStopsLayer);
                }
            });
            
        }
    
    };
        
        // 4. Funci贸n para Renderizar los buses ubicados en la API
    
   window.renderBusLocations = function(busData) {
    const activeBusIds = new Set();
    const locationBusesMap = {}; // Mapa para agrupar buses por ubicaci贸n [lat, lon]

    // 1. Agrupar buses por ubicaci贸n exacta para identificar colisiones
    busData.forEach(bus => {
        // Usamos una clave con precisi贸n alta para la agrupaci贸n
        const key = `${bus.lat.toFixed(6)},${bus.lon.toFixed(6)}`;
        if (!locationBusesMap[key]) {
            locationBusesMap[key] = [];
        }
        locationBusesMap[key].push(bus);
    });

    // Constante de desplazamiento (ajusta este valor si necesitas m谩s o menos separaci贸n)
    const OFFSET = 0.00003; 

    // Icono para los buses (usamos la definici贸n que ya tienes)
    const busIcon = L.divIcon({
        className: 'bus-marker-icon',
        html: '<div style="background-color: #F54927; border-radius: 50%; width: 15px; height: 15px; border: 2px solid #F4320B;"><h></h></div>', 
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });

    // 2. Iterar sobre las agrupaciones y renderizar con desplazamiento si es necesario
    Object.values(locationBusesMap).forEach(busesInLocation => {
        busesInLocation.forEach((bus, index) => {
            const { bus_id, lat, lon, route, velocity } = bus;
            activeBusIds.add(bus_id);

            let adjustedLat = lat;
            let adjustedLon = lon;

            // Aplicar desplazamiento solo si hay m谩s de un bus
            if (busesInLocation.length > 1) {
                // Desplazamiento simple: mueve el marcador ligeramente en latitud y longitud
                // El factor 'index' asegura que cada bus se mueva a un lugar diferente
                adjustedLat = lat + (OFFSET * index); 
                adjustedLon = lon + (OFFSET * index * 0.5); // Desplazamiento menor en longitud para dispersar
            }

            const latlng = [adjustedLat, adjustedLon];
            const popupContent = `<b>Bus ${bus_id}</b><br>Ruta: ${route}<br>Velocidad: ${velocity} km/h<br>Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;

            if (busMarkers[bus_id]) {
                // El marcador ya existe, actualiza su posici贸n
                busMarkers[bus_id].setLatLng(latlng);
                busMarkers[bus_id].setPopupContent(popupContent);
            } else {
                // El marcador no existe, cr茅alo
                busMarkers[bus_id] = L.marker(latlng, { 
                    icon: busIcon,
                    bus_id: bus_id // A帽ade el ID como una opci贸n para referencia
                })
                .bindPopup(popupContent)
                .addTo(map);
            }
        });
    });

    // 3. Eliminar buses que ya no est谩n en los datos
    Object.keys(busMarkers).forEach(busId => {
        if (!activeBusIds.has(busId)) {
            map.removeLayer(busMarkers[busId]);
            delete busMarkers[busId];
        }
    });
};
        map.on('click', function(e) {
            const latlng = { type: 'MAP_CLICK', lat: e.latlng.lat, lng: e.latlng.lng };
            window.ReactNativeWebView.postMessage(JSON.stringify(latlng));
        });
    </script>
</body>
</html>